---
- name: Ensure worker kubeconfigs are present
  shell: "find /kubeconfigs | grep kthw-worker"
  register: result

- set_fact:
    want: "2"
    got: "{{ result.stdout_lines | length }}"

- fail:
    msg: "want {{ want }} kubeconfigs; got {{ got }}"
  when: want != got

- name: Get the Kubernetes API server public IP
  shell: >-
    az network public-ip show -g '{{ azure_resource_group }}' \
      -n "kubernetes-the-hard-way" | jq -r .ipAddress
  register: result

- set_fact:
    kube_api_server_ip: "{{ result.stdout }}"

- name: Ensure the kthw cluster is set to the correct API server
  shell: >-
    kubectl config view -o json --kubeconfig="/kubeconfigs/kthw-worker-{{ item }}.kubeconfig" | \
      jq -r '.clusters[] | select(.name == "kubernetes-the-hard-way") | .cluster.server'
  register: result
  with_sequence: start=1 count=2

- set_fact:
    want: "https://{{ kube_api_server_ip }}:6443"
    got: "{{ result.results | map(attribute='stdout') | flatten | unique | join(',') }}"

- fail:
    msg: "want '{{ want }}', got '{{ got }}'"
  when: want != got
    
- name: Ensure kube-proxy certificate is present
  stat:
    path: /kubeconfigs/kube-proxy.kubeconfig
  register: result

- set_fact:
    want: true
    got: "{{ result.stat.exists }}"

- fail:
    msg: "want {{ want }}; got {{ got }}"
  when: want != got

- name: Ensure kube-proxy cert uses the public API server
  shell: >-
    kubectl config view -o json --kubeconfig="/kubeconfigs/kube-proxy.kubeconfig" | \
      jq -r '.clusters[] | select(.name == "kubernetes-the-hard-way") | .cluster.server'
  register: result

- set_fact:
    want: "https://{{ kube_api_server_ip }}:6443"
    got: "{{ result.stdout }}"

- fail:
    msg: "want '{{ want }}', got '{{ got }}'"
  when: want != got

- name: Ensure kube-controller-manager certificate is present
  stat:
    path: /kubeconfigs/kube-controller-manager.kubeconfig
  register: result

- set_fact:
    want: true
    got: "{{ result.stat.exists }}"

- fail:
    msg: "want {{ want }}; got {{ got }}"
  when: want != got

- name: Ensure kube-controller-manager cert uses localhost
  shell: >-
    kubectl config view -o json --kubeconfig="/kubeconfigs/kube-controller-manager.kubeconfig" | \
      jq -r '.clusters[] | select(.name == "kubernetes-the-hard-way") | .cluster.server'
  register: result

- set_fact:
    want: "https://127.0.0.1:6443"
    got: "{{ result.stdout }}"

- fail:
    msg: "want '{{ want }}', got '{{ got }}'"
  when: want != got

- name: Ensure kube-scheduler certificate is present
  stat:
    path: /kubeconfigs/kube-scheduler.kubeconfig
  register: result

- set_fact:
    want: true
    got: "{{ result.stat.exists }}"

- fail:
    msg: "want {{ want }}; got {{ got }}"
  when: want != got

- name: Ensure kube-scheduler cert uses localhost
  shell: >-
    kubectl config view -o json --kubeconfig="/kubeconfigs/kube-scheduler.kubeconfig" | \
      jq -r '.clusters[] | select(.name == "kubernetes-the-hard-way") | .cluster.server'
  register: result

- set_fact:
    want: "https://127.0.0.1:6443"
    got: "{{ result.stdout }}"

- fail:
    msg: "want '{{ want }}', got '{{ got }}'"
  when: want != got

- name: Ensure admin certificate is present
  stat:
    path: /kubeconfigs/admin.kubeconfig
  register: result

- set_fact:
    want: true
    got: "{{ result.stat.exists }}"

- fail:
    msg: "want {{ want }}; got {{ got }}"
  when: want != got

- name: Ensure controllers have the controller kubeconfigs
  shell: >-
    for ip in $(az network public-ip list | \
      jq -r '.[] | select(.name | contains("control-plane")) | .ipAddress' \
      | grep -v "null"); \
    do \
      ssh -i /secrets/kthw_ssh_key -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          "ubuntu@$ip" "find /home/ubuntu -name '*.kubeconfig'"; \
    done;
  register: result
  ignore_errors: true

- set_fact:
    want:
      - /home/ubuntu/admin.kubeconfig
      - /home/ubuntu/kube-scheduler.kubeconfig
      - /home/ubuntu/kube-controller-manager.kubeconfig
    got: "{{ result.stdout.split('\n') | unique }}"

- set_fact:
    diff: "{{ want | difference(got) }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}, diff: {{ diff }}"
  when: diff | length > 0

- name: Ensure workers have the worker kubeconfigs
  shell: >-
    for ip in $(az network public-ip list | \
      jq -r '.[] | select(.name | contains("worker")) | .ipAddress' \
      | grep -v "null"); \
    do \
      ssh -i /secrets/kthw_ssh_key -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          "ubuntu@$ip" "find /home/ubuntu -name '*.kubeconfig'"; \
    done;
  register: result
  ignore_errors: true
  with_sequence: start=1 count=2

- set_fact:
    want:
      - /home/ubuntu/kube-proxy.kubeconfig
      - /home/ubuntu/kthw-worker-1.kubeconfig
      - /home/ubuntu/kthw-worker-2.kubeconfig
    got: "{{ result.results | map(attribute='stdout_lines') | flatten | unique }}"

- set_fact:
    diff: "{{ want | difference(got) }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}, diff: {{ diff }}"
  when: diff | length > 0


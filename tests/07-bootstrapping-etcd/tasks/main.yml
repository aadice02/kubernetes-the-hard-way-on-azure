---
- name: Ensure etcd and etcdctl is present in /usr/local/bin on all controllers
  shell: >-
    for ip_address in $(az network public-ip list -g '{{ azure_resource_group }}' | \
      jq -r '.[] | select(.name |contains("kthw-control-plane")) | .ipAddress');
    do ssh -i /secrets/kthw_ssh_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
      "ubuntu@$ip_address" find /usr/local/bin/etcd*;
    done
  register: result

- set_fact:
    want: "6"
    got: "{{ result.stdout_lines | length }}"

- fail:
    msg: "want {{ want }}, got {{ got }}, output: {{ result.stdout_lines }}"
  when: want != got

- name: Ensure etcd folders present and permissioned correctly
  shell: >-
    for ip_address in $(az network public-ip list -g '{{ azure_resource_group }}' | \
      jq -r '.[] | select(.name |contains("kthw-control-plane")) | .ipAddress');
    do ssh -i /secrets/kthw_ssh_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
    "ubuntu@$ip_address" -- "ls -ld {{ item }} | grep -v total | awk '{print \$1\" \"\$NF}'";
    done
  register: result
  with_items:
    - /var/lib/etcd
    - /etc/etcd

- set_fact:
    want:
      - "drwx------ /var/lib/etcd"
      - "drwxr-xr-x /etc/etcd"
    got: "{{ result.results | map(attribute='stdout_lines') | flatten | unique }}"

- set_fact:
    diff: "{{ want | difference(got) }}"

- fail:
    msg: "want {{ want }}, got {{ got }}, diff: {{ diff }}"
  when: diff | length > 0

- name: Ensure certificates are in /etc/etcd on all controllers
  shell: >-
    for ip_address in $(az network public-ip list -g '{{ azure_resource_group }}' | \
      jq -r '.[] | select(.name |contains("kthw-control-plane")) | .ipAddress');
    do ssh -i /secrets/kthw_ssh_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
      "ubuntu@$ip_address" find /etc/etcd/*.pem;
    done
  register: result

- set_fact:
    want:
      - /etc/etcd/ca.pem
      - /etc/etcd/kubernetes-key.pem
      - /etc/etcd/kubernetes.pem
    got: "{{ result.stdout_lines | unique }}"

- set_fact:
    diff: "{{ want | difference(got) }}"

- fail:
    msg: "want {{ want }}, got {{ got }}, diff: {{ diff }}"
  when: diff | length > 0

- name: Ensure etcd service is present
  shell: >-
    for ip_address in $(az network public-ip list -g '{{ azure_resource_group }}' | \
      jq -r '.[] | select(.name |contains("kthw-control-plane")) | .ipAddress');
    do ssh -i /secrets/kthw_ssh_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
      "ubuntu@$ip_address" 'find /etc/systemd/system/etcd.service';
    done
  register: result

- set_fact:
    want: "3"
    got: "{{ result.stdout_lines | length }}"

- fail:
    msg: "want {{ want }}, got {{ got }}, output: {{ result.stdout_lines }}"
  when: want != got


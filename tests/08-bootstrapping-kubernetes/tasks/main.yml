---
- name: /etc/kubernetes/config exists
  shell: >-
    for ip_address in $(az network public-ip list -g '{{ azure_resource_group }}' | \
      jq -r '.[] | select(.name |contains("kthw-control-plane")) | .ipAddress');
    do ssh -i /secrets/kthw_ssh_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
      "ubuntu@$ip_address" \
      find /etc/kubernetes/config -type d;
    done
  register: result

- set_fact:
    want: "3"
    got: "{{ result.stdout_lines | length }}"

- fail:
    msg: "want {{ want }}, got {{ got }}, output: {{ result.stdout_lines }}"
  when: want != got

- name: Ensure Kubernetes binaries are present and are the correct version
  shell: >-
    for ip_address in $(az network public-ip list -g '{{ azure_resource_group }}' | \
      jq -r '.[] | select(.name |contains("kthw-control-plane")) | .ipAddress');
    do ssh -i /secrets/kthw_ssh_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
      "ubuntu@$ip_address" -- \
          'printf "$(hostname -s): kubectl version " && kubectl version --client=true -o json | jq -r .clientVersion.gitVersion; \
          printf "$(hostname -s): kube-apiserver version " && kube-apiserver --version | sed "s/Kubernetes //"; \
          printf "$(hostname -s): kube-controller-manager version " && kube-controller-manager --version | sed "s/Kubernetes //"; \
          printf "$(hostname -s): kube-scheduler version " && kube-scheduler --version | sed "s/Kubernetes //";';
    done
  register: result

- set_fact:
    data:
      - "kthw-control-plane-1: {{ item }} version v{{ kubernetes_version }}"
      - "kthw-control-plane-2: {{ item }} version v{{ kubernetes_version }}"
      - "kthw-control-plane-3: {{ item }} version v{{ kubernetes_version }}"
  register: versions
  with_items:
    - kubectl
    - kube-apiserver
    - kube-controller-manager
    - kube-scheduler

- set_fact:
    want: "{{ versions.results | map(attribute='ansible_facts.data') | flatten }}"
    got: "{{ result.stdout_lines }}"

- set_fact:
    diff: "{{ want | difference(got) }}"

- fail:
    msg: "want {{ want }}, got {{ got }}, diff: {{ diff }}"
  when: diff | length > 0

- name: Certificates and encryption key are present
  shell: >-
    for ip_address in $(az network public-ip list -g '{{ azure_resource_group }}' | \
      jq -r '.[] | select(.name |contains("kthw-control-plane")) | .ipAddress');
    do ssh -i /secrets/kthw_ssh_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
      "ubuntu@$ip_address" \
      'find /var/lib/kubernetes -name "*.pem" -o -name "*.yaml" | grep -v kube-scheduler'
    done
  register: result

- set_fact:
    want: "21"
    got: "{{ result.stdout_lines | length }}"

- fail:
    msg: "want {{ want }}, got {{ got }}, output: {{ result.stdout_lines }}"
  when: want != got

- name: Kubernetes control plane services started
  shell: >-
    for ip_address in $(az network public-ip list -g '{{ azure_resource_group }}' | \
      jq -r '.[] | select(.name |contains("kthw-control-plane")) | .ipAddress');
    do ssh -i /secrets/kthw_ssh_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
      "ubuntu@$ip_address" \
      'for svc in kube-apiserver kube-controller-manager kube-scheduler; \
        do systemctl is-active --quiet $svc || { echo "Not active: $svc"; exit 1; }; \
       done';
    done
  register: result
  ignore_errors: true

- set_fact:
    want: "0"
    got: "{{ result.rc }}"

- fail:
    msg: "want {{ want }}, got {{ got }}, output: {{ result.stdout_lines }}"
  when: want != got

- name: Verify /healthz exists
  shell:
    for ip_address in $(az network public-ip list -g '{{ azure_resource_group }}' | \
      jq -r '.[] | select(.name |contains("kthw-control-plane")) | .ipAddress');
    do ssh -i /secrets/kthw_ssh_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
      "ubuntu@$ip_address" \
      'test -h /etc/nginx/sites-enabled/kubernetes.default.svc.cluster.local || exit 1';
    done
  register: result
  ignore_errors: true

- set_fact:
    want: "0"
    got: "{{ result.rc }}"

- fail:
    msg: "want {{ want }}, got {{ got }}, output: {{ result.stdout_lines }}"
  when: want != got

- name: Confirm that cluster is okay
  shell:
    for ip_address in $(az network public-ip list -g '{{ azure_resource_group }}' | \
      jq -r '.[] | select(.name |contains("kthw-control-plane")) | .ipAddress');
    do ssh -i /secrets/kthw_ssh_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
      "ubuntu@$ip_address" \
      'kubectl get componentstatuses --kubeconfig admin.kubeconfig -o json' | \
        jq -r '.items[] | .metadata.name + ", " + .conditions[0].message';
    done
  register: result
  ignore_errors: true

- set_fact:
    want:
      - "scheduler, ok"
      - "controller-manager, ok"
      - 'etcd-0, {"health":"true"}'
      - 'etcd-1, {"health":"true"}'
      - 'etcd-2, {"health":"true"}'
    got: "{{ result.stdout_lines | unique }}"

- set_fact:
    diff: "{{ want | difference(got) }}"

- fail:
    msg: "want {{ want }}, got {{ got }}, diff: {{ diff }}"
  when: diff | length > 0


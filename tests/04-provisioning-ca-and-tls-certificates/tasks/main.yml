---
- name: Ensure the CA root certificate and private key exist
  shell: find /secrets -name "ca*.pem"
  register: result

- set_fact:
    want:
      - /secrets/ca.pem
      - /secrets/ca-key.pem
    got: "{{ result.stdout.split('\n') }}"

- set_fact:
    diff: "{{ want | difference(got) }}"

- fail:
    msg: "want: {{ want }}; got: {{ got }}; diff: {{ diff }}"
  when: diff | length > 0

- name: Ensure the CA root certificate is correct
  shell: >-
    openssl x509 -in /secrets/ca.pem 2>/dev/null -text -noout | \
    grep "Subject:" | \
    sed 's/^ \+//' | \
    sed 's/ = /=/g'
  register: result

- set_fact:
    want: "Subject: C=US, ST=Texas, L=Dallas, O=Kubernetes, OU=CA, CN=Kubernetes"
    got: "{{ result.stdout }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}"
  when: want != got

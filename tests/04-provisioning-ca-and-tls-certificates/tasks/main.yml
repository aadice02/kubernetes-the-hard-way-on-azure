---
- name: Ensure the CA root certificate is correct
  shell: >-
    openssl x509 -in /secrets/ca.pem 2>/dev/null -text -noout | \
    grep "Subject:" | \
    sed 's/^ \+//' | \
    sed 's/ = /=/g'
  register: result

- set_fact:
    want: "Subject: C=US, ST=Texas, L=Dallas, O=Kubernetes, OU=CA, CN=Kubernetes"
    got: "{{ result.stdout }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}"
  when: want != got

- name: Ensure that admin certificate is correct and has the CA in its chain
  shell: >-
    openssl verify -CAfile /secrets/ca.pem /secrets/admin.pem
  register: result

- set_fact:
    want: "/secrets/admin.pem: OK"
    got: "{{ result.stdout }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}"
  when: want != got

- name: Ensure that each worker's cert is present and validates
  shell: >-
    openssl verify -CAfile /secrets/ca.pem "/secrets/kthw-worker-{{ item }}.pem"
  register: result
  with_sequence: start=1 count=3

- debug:
    msg: "{{ result }}"

- set_fact:
    want: "/secrets/kthw-worker-{{ item }}.pem: OK"
    got: "{{ result.results }}"
  with_sequence: start=1 count=3
  register: test_results

- debug:
    msg: "{{ test_results }}"

- fail:
    msg: "want: {{ test_results.results }}, got: {{ item.got }}"
  when: want != got
  with_sequence: start=1 count=3

---
- name: Ensure the CA root certificate is correct
  shell: >-
    openssl x509 -in /secrets/ca.pem 2>/dev/null -text -noout | \
    grep "Subject:" | \
    sed 's/^ \+//' | \
    sed 's/ = /=/g'
  register: result

- set_fact:
    want: "Subject: C=US, ST=Texas, L=Dallas, O=Kubernetes, OU=CA, CN=Kubernetes"
    got: "{{ result.stdout }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}"
  when: want != got

- name: Ensure that admin certificate is correct and has the CA in its chain
  shell: >-
    openssl verify -CAfile /secrets/ca.pem /secrets/admin.pem
  register: result

- set_fact:
    want: "/secrets/admin.pem: OK"
    got: "{{ result.stdout }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}"
  when: want != got


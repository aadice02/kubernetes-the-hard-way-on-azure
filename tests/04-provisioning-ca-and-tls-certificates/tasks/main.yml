---
- name: Ensure the CA root certificate is correct
  shell: >-
    openssl x509 -in /secrets/ca.pem 2>/dev/null -text -noout | \
    grep "Subject:" | \
    sed 's/^ \+//' | \
    sed 's/ = /=/g'
  register: result

- set_fact:
    want: "Subject: C=US, ST=Texas, L=Dallas, O=Kubernetes, OU=CA, CN=Kubernetes"
    got: "{{ result.stdout }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}"
  when: want != got

- name: Ensure that admin certificate is correct and has the CA in its chain
  shell: >-
    openssl verify -CAfile /secrets/ca.pem /secrets/admin.pem
  register: result

- set_fact:
    want: "/secrets/admin.pem: OK"
    got: "{{ result.stdout }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}"
  when: want != got

- name: Ensure that each worker's cert is present and validates
  shell: >-
    for idx in $(seq 1 3); \
    do openssl verify -CAfile /secrets/ca.pem "/secrets/kthw-worker-$idx.pem"; \
    done;
  register: result

- set_fact:
    want:
      - "/secrets/kthw-worker-1.pem: OK"
      - "/secrets/kthw-worker-2.pem: OK"
      - "/secrets/kthw-worker-3.pem: OK"
    got: "{{ result.stdout.split('\n') }}"

- set_fact:
    diff: "{{ want | difference(got) }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}, diff: {{ diff }}"
  when: diff | length > 0

- name: Ensure that kube-proxy certificate is correct and has the CA in its chain
  shell: >-
    openssl verify -CAfile /secrets/ca.pem /secrets/kube-proxy.pem
  register: result

- set_fact:
    want: "/secrets/kube-proxy.pem: OK"
    got: "{{ result.stdout }}"

- fail:
    msg: "want: {{ want }}, got: {{ got }}"
  when: want != got

